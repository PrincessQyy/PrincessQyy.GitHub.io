---
layout:     post
title:      "【Linux】主机的基本防护"
date:       2017-05-14 10:05:00
author:     "Yuki"
---

在谈主机的基本防护之前，我们先来看看网络数据包在进入主机取得实际数据之前的整个流程是怎样的，这样更有助于了解要怎样才能更好的保护主机。

## 数据包进入主机的流程

数据包进入主机的过程可以用下面的图来表示：

<img src="../../../../../img/blogs/protection of hosts/01.png">

#### 经过防火墙的分析

Linux默认的防火墙机制有两个，一层是数据包过滤式的Netfilter，一层是通过软件管理的TCP Wrappers。

**数据包过滤防火墙**

这就是iptables软件所提供的防火墙功能，为何称为数据包过滤防火墙呢？因为他主要是针对TCP/IP的数据包头部来进行过滤的机制，主要分析的是OSI的二、三、四层，主要控制的是MAC、IP、ICMP、TCP、UDP的端口与状态等。

**TCP Wrappers**

过了Netfilter后，数据包就开始经过TCPWrappers的检验，这是什么功能呢？说穿了就是/etc/hosts.allow和/etc/hosts.deny的配置文件，你可以设置一些机制来过滤某些IP或port。

#### 服务的基本功能

防火墙管理的是数据包头的信息，如果想要允许某些目录可以进入，某些目录不能进入，就需要通过权限及服务器软件提供的相关功能了，例如：你可以在httpd.conf这个配置文件内规范某些IP来源不能使用httpd这个服务来取得主机的数据。

#### SELinux对网络服务的详细权限控制

SELinux可以针对网络服务的一些权限来设置一些规则，让程序能够拥有的功能有限。因此当用户的文件权限设置错误，以及程序有问题时，即使使用的是root权限，该程序所能执行的操作也是被限制的！这相当有必要哦~

#### 主机的文件系统权限

网络数据包最终是要获取主机内的文件系统数据的，所以，网页数据的权限当然就是要让httpd这个程序能够读取才行。

#### 日志文件

在以上三个步骤之外，Linux以及相关软件还具有支持登录文件记录的功能。为了方便管理者在未来的错误查询与入侵检测，良好的日志分析习惯是一定要建立的，尤其是/var/log/messages和/var/log/secure这些文件。

## 常见的攻击手段和相关保护

要想了解如何防护主机安全，一定得了解主机被攻击的手段，所谓，知己知彼，百战百胜嘛~

#### 取得账户信息后猜密码

这种攻击方式是最早期的入侵方式了，攻击者知道你的账号，或者可以猜出你的账号的话，就可以通过高级的社会工程学来猜测你的密码了，所以如果密码规划不好的话，也会很容易被攻击了，所以良好的密码设置习惯是很必要的。

不过这种攻击方式现在已经不流行了，好多软件都有密码输入次数的限制~这也是初级的攻击者使用的方式之一，那我们要怎么防护呢？

* 减少信息曝光机会
* 建立较严格的密码设置规则：如果主机够稳定且不会持续加入某些账号，可以使用chatter来限制/etc/passwa、/etc/shadow的更改。
* 完善的权限设置：由于这种方式可能会取得某账号的登录权限，所以如果系统权限设置得宜的话，对主机的伤害也比较有限啦。


#### 利用系统的程序漏洞进行攻击

如果主机开放了网络服务的话，就必须要启动某个网络软件，由于软件编写的问题，可能会有攻击者能利用的漏洞，当程序的问题被公布，可能会有高水平的攻击者尝试撰写一些针对这个漏洞的攻击程序代码公布到网站上，就有可能会有一些黑帽子取得这些代码后，会尝试攻击你的主机。

这也是最常见的攻击方式，就像最近大规模爆发勒索病毒，这是由NSA泄漏的“永恒之蓝”黑客工具包传播的，黑客使用NSA泄漏的黑客工具包攻击Windows漏洞，把ONION、WNCRY等勒索病毒在校园网快速传播感染，而“永恒之蓝”可远程攻击Windows的445端口(文件共享)，在取得一定权限后，对主机重要文件进行加密，然后以此来勒索。但这种攻击方式本身是依靠程序漏洞实现的，所以如果主机随时保持在更新的状态，或是关闭大部分不需要的程序，就可以避开这个问题。所以防护方法主要有以下几点：

* 关闭不需要的网络服务
* 随时保持更新
* 关闭不需要的软件功能

#### 利用程序的“被动”攻击

可能你会说，不都是主动来攻击我嘛，怎么还会有被动攻击呀~你别说，还真有，如果你经常访问一些来历不明的网站的话，有的时候可能会连上一些弹窗，或者是广告，你可能会说，我访问的都是一些比较干净的网站，那人总有粗心的时候吧，假如某天你突然收到一封邮件，说你银行卡账号有问题，希望你点击某网址去更改账号密码，你会不会上当？如果说某网站搞大促销，你会不会去看看？都是可能的啊！所以要如何防护呢？

* 随时更新主机上的软件：如果浏览器是没有问题的，那对方传递恶意代码的时候，浏览器就不会执行，那自然安全多了。
* 较小化软件功能：例如，让你的收信软件不要主动去下载文件，让浏览器要安装某些功能的时候需要手动确认等。
* 不要连接到不明的主机：其实这个是最难的，因为很多时候我们会在网上搜索信息，如果答案说在某某网址...我们还是很有可能会点进去的...

#### 蠕虫或木马的Rootkit

Rootkit是指可以取得root权限的一群工具组，Rootkit主要也是通过主机的程序漏洞来即进行攻击的，不过它也会利用社会工程学来让用户下载、安装Rootkit软件，从而让攻击者可以轻易地绑架对方的主机。

Rootkit除了通过上述方法来进行攻击以外，还会进行伪装和自我复制，本身很多的Rootkit就是蠕虫或是木马间谍程序。蠕虫会让你的主机一直发送数据包向外进行攻击，结果你的网络带宽就会被吃光，至于木马程序，则是会在你的主机中开启后门，也就是说你的操作，会主动地发送到对方主机上...结果当然也是被绑架了。

Rootkit不好追踪，因为他通常会修改系统命令，包括ls、top、netstat、ps、who、last、find等，让你看不到程序有问题，然后又很容易就中招，你的主机就很容易被当成跳板，很危险呐！那么要怎么防护呢？

* 不要随意安装不明来源的软件或是不明网站的文件数据
* 不要让系统有太多危险指令：例如SUID/SGID的程序可能会造成用户使用不当，从而让木马程序有机可乘。
* 可以定时以RKHunter之类的软件来追查：有一个网站可以提供Rootkit程序的检查，可以去下载：[](http://www.rootkit.nl/projects/rootkit_hunter.html)

#### DDos攻击

这种攻击方式比较无赖，主要就是消耗你主机的资源，更可怕的是，通常攻击主机的一方不会只有一台，他会通过Internet上的僵尸网络发动全体攻击，让你的主机在短时间内就“挂掉”。他不是入侵你的系统，而是让你的系统无法正常提供服务。

这种攻击方式是最难处理的，因为要么需要系统核心有支持自动抵挡DDOS的机制，要么自行撰写侦测软件来进行判断，非常麻烦。

#### 总结

要让系统安全是需要技术方法的，维护网站也是比架设网站更为重要，所以下面就总结一些基本的主机防护的点吧，大多数的在前面也提到了：

* 建立完善的登录密码规则的限制
* 完善的主机权限设置
* 设置自动升级与修补软件漏洞以及移除危险软件
* 在每项系统服务的设置当中，强化安全设置的项目
* 利用iptables、TCP Wrappers强化网络防火墙
* 利用主机监控软件（如MRTG与logwatch）来分析主机状况与日志文件

## 主机受攻击后的恢复流程

主机被攻击后，很多人都习惯“只要把root密码改回来就行了”，其实这样还是有风险啊，主机有可能被用做中继站，所以最好的方法就是重装系统！当然，不可能每一次被攻击了都重装，所谓吃一堑长一智，下面来看看主机被攻击了要怎么修复吧~

#### 立即拔除网线

既然被入侵了，那么第一件事就是拿掉网络功能。事实上，拔除网线不但可以保护自己的主机，还可以保护局域网内的其他主机。很多病毒都会感染同网段内的所有主机，所以拔除网线是很重要的。

#### 分析日志文件，查找可能的入侵途径

** 分析日志文件**

低级的攻击者通常是利用工具来入侵系统的，所以可以通过分析日志文件来找出对方的IP以及有问题的漏洞，例如/var/log/messages和/var/log/secure，还可以利用last命令来找出上次登录者的信息

**检查主机开发的服务**

找出系统上的服务，然后检查一下是否有漏洞，或者设置上是否有缺陷。

**查询Internet上的安全通报**

通过安全通报来了解最新的漏洞信息，说不定问题就出在上面。

**重要数据备份**

这里先说一下什么是重要数据，重要数据指的是非Linux系统的原有数据，例如/etc/passwd、/etc/shadow、www网页的数据、/home里用户的重要文件等，记住，不要备份二进制文件，因为Linux安装完毕后本来就有这些文件，而且这些文件很有可能被篡改过了，备份这些数据反而会使再次安装的系统不干净。

**重新安装**

在这次安装中，最好选择你需要的软件安装就好，不要把所有软件都装上。

**软件的漏洞修补**

重装完毕后，请将软件升级到最新版本。一个比较好的做法是：先在比较干净的环境下将Internet上的漏洞修补软件下载下来，然后刻录CD，再拿到刚安装好的系统上，mount CD会全部进行更新，然后设置相关的防火墙机制，再关闭或移除不必要的服务后，才将网线插上。

**关闭或删除不需要的服务**

启用的服务越少，系统被入侵的可能性就越低。

**数据恢复与恢复服务设置**

将备份的数据复制到系统中，再将系统的服务重新开放，这些服务的设置最好都再确认一下。


