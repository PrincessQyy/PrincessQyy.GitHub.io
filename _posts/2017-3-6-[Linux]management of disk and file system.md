---
layout:     post
title:      "【Linux】磁盘和文件系统管理"
date:       2017-03-06 16:29:00
author:     "Yuki"
---

## 磁盘管理

#### 磁盘的基本概念

* 在Linux中，所以设备都被抽象为一个文件，保存在/dev目录下。设备名称一般为hd[a-z]或sd[a-z]。

* IDE设备的名称为hd[a-z]，SATA、SAS、USB等设备的名称为sd[a-z]。

#### 分区概念

将一个磁盘逻辑的分为几个区，每个区当做独立的磁盘，以方便管理和使用。不同的分区用：设备名称+分区号表示。如：sda1,hdb2.

主流的分区机制有MBR和GPT两种。

**MBR:**

传统的分区机制，应用于绝大多数使用BIOS的PC设备。其特点有：

* 支持32bit和64bit的系统
* 支持的分区数量有限
* 只支持不超过2T的硬盘
* 最多只能创建4个主分区
* 一个扩展分区会占用一个主分区的位置
* Linux最多支持63个IDE分区和15个SCSI分区

附：扩展分区是逻辑分区的总称，所以我们能用来存储数据的只有主分区和逻辑分区。

**GPT：**较新的分区机制，解决了MBR的很多缺点。其特点有：

* 只支持64bit的系统
* 向后兼容MBR
* 支持超过2T的硬盘
* 必须在支持EFI的硬件上才能使用
* Mac、Linux、Windows7 64bit、WindowsServer2008 64bit系统支持GPT分区格式

附：EFI，可扩展固件接口，英文名Extensible Firmware Interface 的缩写，是英特尔一个主导个人电脑技术研发的公司推出的一种在未来的类PC的电脑系统中替代BIOS的升级方案。

#### 使用fdisk进行分区操作

在Linux中，我们使用 fdisk 工具来进行分区。注意：fdisk是针对MBR的分区工具，若要用GPT的，则无法使用MBR来进行分区操作。

**关于 fdisk**

* fdisk是只有超级用户才能执行的命令
* fdisk -l 可以列出所有磁盘及其分区信息
* fdisk 目标磁盘 可以对目标磁盘进行分区操作(具体分区细节按提示进行即可)
* 分区后需要用 partprobe 命令让内核更新分区信息，否则得重启才能识别新的分区
* /proc/partition 文件也可以用来查看分区信息 （proc文件中大部分都是系统的实时信息）

## 文件系统管理

#### 基本信息

操作系统通过文件系统管理文件和数据。磁盘或分区需要创建文件系统才能使用，创建文件系统的过程又称为格式化。

* 没有文件系统的设备称为裸设备
* 常见的文件系统有 NTFS、ext2、ext3、ext4、fat2、xfs、HFS等
* Windows下主流的文件系统：NTFS；Linux下主流的文件系统：ext3、ext4

#### 文件系统的创建

* 用命令 mke2fs 来创建文件系统，常用参数有：

-b blocksize 指定文件系统块大小(默认是4K)

-c 建立文件系统时检查块损坏
-L lable 指定卷标

-j 建立文件系统日志

-t fs_type 指定文件系统类型

* 命令mkfs也可以用来创建文件系统，但是支持的参数较少，不能进行精细化的控制，使用格式为：mkfs.fs_type 目标分区

#### 查看文件系统信息

命令 dumpe2fs 可以用来查看分区的文件系统信息

#### 带日志的文件系统

带日志的文件系统（ext3、ext4）具有较好的稳定性，在出现错误时可以进行恢复。带日志的文件系统会使用一个叫做“两阶段提交”的方式操作磁盘，当进行磁盘操作时，文件系统进行以下操作：

1) 文件系统将准备执行的事务的具体内容写入日志

2) 文件系统进行操作

3) 操作成功后，该事务从日志中删除

这样做的好处就是，在事情没有完成就被打断的情况下（可能断电或者磁盘故障），可以事后通过查看日志来恢复操作。缺点是额外的日志读写操作会丧失一定的性能，但是和丧失的那一点性能相比，我们通常都希望系统具有更好的稳定性。所以，文件系统的日志是很重要的。

#### 标签

通常情况下，我们都需要为磁盘打上标签，标签有助于我们管理磁盘，直观看出磁盘的用途。命令 e2lable 可以用来为文件系统添加标签。用法为：

* e2lable 目标磁盘 显示目标磁盘的系统标签
* e2lable 目标磁盘 标签名 为目标磁盘设置标签（标签名通常都是大写
）

#### 文件系统的修复

命令 fsck 用来检查和修复损坏的文件系统（检查文件系统时系统必须是卸载的），用法为：fsck 目标磁盘 。常用参数有：

-y 不提示而直接进行修复

-t 指定文件系统类型（默认fsck会自动判断文件系统类型，但在损坏较严重的情况下，建议加上-t参数指明文件系统类型）

附：

* 对于识别为文件系统的损坏数据（文件系统无记录），fsck会将该文件放入lost+found目录
* 系统启东时会对磁盘进行fsck操作

#### 文件系统挂载管理

**手动挂载**

磁盘或分区创建好文件系统后，必须要挂载到一个目录才能使用。Windows和Mac系统会自动进行挂载，Linux系统需要我们手动挂载或者手动配置使其自动挂载。

单独的 mount 命令会显示所有已挂载的文件系统

要使用命令 mount 来对文件系统进行挂载操作，使用方法为：`    mount 要挂载的设备 要挂载的目录`
    
常用参数有：

-t 指定文件系统类型

-o 指定挂载选项

* ro,rw 以只读或读写形式挂载，默认是rw
* sync 代表不使用缓存，对所有操作直接写入磁盘（通常，在对文件安全性有较大的要求时，会使用该选项，因为在操作中，若是断电或者机器出现故障，被写的数据很有可能还在缓存中，未写入磁盘，可能会导致数据的丢失，所以我们使用该选项让修改直接写入磁盘）
* async 代表使用缓存，默认也是该选项
* noatime 代表每次访问文件时不更新文件的访问时间（通常在对文件有频繁操作的磁盘使用该选项，因为频繁更改文件访问时间会降低系统性能）
* remount 重新挂载文件系统

附：有多个选项时，选项间以逗号分隔。

**自动挂载**

配置文件 /etc/fstab 用来定义需要自动挂载的文件系统。其中每一行代表一个挂载配置，格式如下：
<img src="../../../../../img/blogs/management of disk and file system/disk.png">

要挂载的设备也可用其标签进行识别。

命令 mount -a 会挂载所有 fstab 中定义的自动挂载项。


**卸载**

命令 umount 用来卸载已挂载的文件系统。使用方法为：umount 文件系统/挂载点

如果出现device is busy 报错，表示该文件系统正在被使用，无法卸载，可以用命令` fuser -m 挂载点` 来查看使用文件系统的进程。也可以使用命令 `lsof 挂载点 `来查看正在被使用的文件。




