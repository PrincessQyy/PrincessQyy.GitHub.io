---
layout:     post
title:      "【Linux】日志小结"
date:       2017-04-19 20:39:00
author:     "Yuki"
---

(⊙﹏⊙)京东二面问到了我日志，当时大脑突然一片空白，今天想着查缺补漏，翻开鸟哥的私房菜，才发现其实我看过日志这部分了啊，当时也查看了虚拟机上的一些日志！！！我的天，及时总结很重要，不然面试的时候真的有可能脑子短路，还以为自己没学过...还有就是以后面试真的不要太紧张(╥╯^╰╥)

#### 日志文件的重要性

* 解决系统方面的错误

系统使用久了，可能会出现一些错误，例如硬件捕获不到，或者某些系统程序无法顺利运行，此时就可以查看日志，找出错误原因。

* 解决网络服务的问题

网络服务的各种问题通常都会被写入特别的日志，所以只要查询日志就能发现出了什么差错。例如邮件服务器无法启动，就可以查询/var/log/mail文件。

* 过往事件记录簿

这个东西相当重要！例如，某时刻你的Apache流量变得很大，你想要了解原因，就可以通过日志去找出该时段是哪些IP在联机与查询的网络数据是什么。

#### Linux常见日志名

* /var/log/cron

crontab定制的例行性任务的执行情况、有没有被执行、/etc/crontab编写是否正确等信息都保存在这个日志中。

* /var/log/dmesg

记录系统在开机时内核检测过程所产生的各项信息。

* /var/log/lastlog

记录系统上所有账号最近一次登录系统时的相关信息。

* /var/log/maillog  

记录sendmail（SMTP协议提供者）和dovecop（POP3协议提供者）所产生的信息。

* /var/log/messages

这个文件相当重要！！！几乎系统发生的错误（或是重要信息）都会记录在这个日志中，如果系统出现莫名的错误，这个日志是一定要查询的日志之一！！！

* /var/log/secure

只要涉及到输入密码的软件，当登录（不管失败与否）时都会被记录在该文件中。包括系统的login程序、su、sudo等程序，还有ssh、Telnet等程序，登录信息都会被记录在这里。

* /var/log/wtmp 和 /var/log/faillog

这两个文件记录了正确登录系统者的信息和错误登录者的账户信息。对于追踪一般账号使用者的行为很有帮助。

* /var/log/httpd/\* ，/var/log/news/\*，/var/log/samba/\*

个别网络服务所定制的日志文件，记录其产生的各项信息。

#### 日志文件所需daemon与进程

这些日志文件是怎么产生的呢？基本有两种方式，一是软件开发商自行定义写入的日志文件与相关格式，例如Apache就是这么做的；二是Linux Distribution提供的日志文件管理服务来统一管理，例如CentOS就是通过syslogd这个服务来统一管理日志文件的。

除了syslogd来管理系统信息外，内核也需要有专门的服务来进行管理，这个服务就是klogd，所以，日志文件所需的服务主要就是syslogd和klogd。

不过，要是任由你的日志没完没了的记录的话，相信过不了多久，你的日志容量会变得相当大，这可能会导致大文件读写效率不佳，所以，日志文件是需要备份和更新的，当然，这不需要我们手动操作，因为有 logrotate 这个服务，这个服务主要就是负责日志的轮替，简单的说就是将旧的文件更改名称，然后新建一个空白日志文件，这样一来，新的日志文件记录消息，旧的文件在保存一段时间后系统自动将它清除。

#### syslogd

**启动syslogd服务**

命令`ps aux | grep syslog`用以查看syslogd服务是否启动。一般都是默认启动了的。

**日志文件内容的形式**

日志文件一般都有以下信息记录：

1. 事件发生的日期和时间
2. 发生此事件的主机名
3. 启动该事件的服务
4. 信息的实际数据内容

**检查错误的小技巧**

当某个服务老是无法启动时，可以在最后一次启动这个服务后立即检查日志文件，找到现在的登录信息，来找到错误点。

**syslog的配置**

syslog的配置文件在/etc/rsyslog.conf。这个文件规定了什么服务的什么类型的信息需要被记录在哪里。

syslog设置的服务主要有以下这些：

* auth:与认证有关的机制，如ssh、login、su等
* cron：例行性工作
* daemon：各个daemon相关信息
* kern:内核产生信息的地方
* mail:邮件收发相关信息
* news：新闻组服务器有关的信息
* syslog：syslogd程序本身生成的信息

信息等级有如下这些：

* 等级1：info，仅是一些基本信息的说明
* 等级2：notice，除了info外还需要注意的一些信息内容
* 等级3：warning（warn），警示的信息，可能有错误，但还不至于影响到某个daemon的运行
* 等级4：err，一些重大的错误，例如配置文件的某些设置可能会导致服务无法启动，通常通过err告知的错误可以了解到该服务无法启动的原因
* 等级5：crit，比err还要严重的错误信息
* 等级6：alert，警告，很严重的错误等级
* 等级7：emerge，系统几乎要死机了...通常只有硬件出现问题才会导致整个内核无法顺利运行
* debug、none：当需要做错误检测或忽略某些信息时，可以用这两个

服务和等级之间的连接符号：

* "." :表示比后面等级要高的等级（大于等于）
* ".=":所需的等级就是后面指定的等级
* ".!":不需要该等级

信息记录的文件名或主机或设备：

* 文件的绝对路径：通常在/var/log下
* 用户名称：显示给用户
* 远程主机：例如@www.princess7.top，当然，要对方主机也支持才行
* \*:代表目前在线的所有人

下面举几个例子来说明在配置文件中怎么添加内容：

*  messages需要记录除了cron、mail、news的信息：

    `*.* news,cron,mail.none		/var/log/messages`

* cronnews中需要记录cron和news的所有信息，其中警告信息单独记录在cronwarn中

   ` cron.*；news.*	 	/var/log/cron`
    `cron.=warn 	/var/log/cronwarn`

下面来看看我CentOS的syslog配置文件：

<img src="../../../../../img/blogs/logs/01.png">

与上面例子相似的语法我就不一一说明是什么意思了，注意到/var/log/messages中存储的信息很多，所以这个日志很重要！

还有`*.emerg   omusrmsg:*`omusrmsg 是内置模块，发送日志到指定用户，这句语法的意思是将系统产生的所有emerg信息广播给所有登录的用户。












