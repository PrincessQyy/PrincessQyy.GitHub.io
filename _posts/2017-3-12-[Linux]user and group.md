---
layout:     post
title:      "【Linux】用户及权限管理"
date:       2017-03-12 08:45:00
author:     "Yuki"
---

#### 用户、组的基本概念

使用Linux时，需要以一个用户的身份登入，一个进程也需要以用户的身份去运行。用户限制了使用者和进程对资源的使用。而组的存在，是为了方便管理用户的。

**基础知识**

* 每个用户拥有一个UserID，操作系统实际使用的是用户ID，而非用户名
* 每个用户属于一个主组（通常和用户名同名），属于一个或多个附属组
* 每个组拥有一个组ID
* 每个可登陆用户拥有一个指定的shell
* 用户ID为32位，但为了兼容老系统，ID限制在60000以下
* 系统中的每一个文件都有所属用户及所属组
 
**用户分类**

1. root用户：ID为0的用户为root用户
2. 系统用户：ID在1~499，往往没有登陆shell，往往其是为某些服务/进程创建的
3. 普通用户：ID在500以上

**相关文件**

* /etc/passwd    该文件保存用户信息
* /etc/shadow    该文件保存加密后的用户密码
* /etc/group     该文件保存组信息

**查看用户**

* 命令 `id `可以显示当前用户信息
* 命令 `whoami `显示当前用户
* 命令 `who `显示有哪些用户已经登录系统
* 命令` w `显示有哪些用户已经登录并且在干什么 

ლ(╹◡╹ლ)话说，Linux有个约定俗称的小规律，就是命令越短显示的信息反而越多

**修改用户密码**

使用命令` passwd `可以修改用户密码

**创建用户**

* 命令 `useradd` 用以创建一个用户

常用参数有：

-d 家目录

-s 登录shell

-u userid 设置用户id

-g 主组 设置主组

-G 附属组 设置附属组，最多31个，用“,”分隔

附：也可以通过修改/etc/passwd来设置，但是不建议这么做，万一错改了其他的用户，可能会造成系统不稳定。

创建用户的命令会执行一下操作:

1. 在 /etc/passwd 中添加用户信息
2. 如果使用 passwd 命令创建了用户密码，则 /etc/shadow 中会保存用户密码
3. 为用户创建新的家目录 /home/user_name
4. 将 /etc/skel 中的文件复制到用户的家目录中
5. 建立一个与用户名相同的组，新建的用户默认从属于这个同名组

**修改用户信息**

命令 `usermod` 用来修改用户信息

参数有：

-l new_name old_name 修改用户名

-u new_userid user_name 修改用户id

-d new_document user_name 修改用户家目录位置

-g new_group user_name 修改用户主组 

-G 附属组 user_name 修改用户附属组

-L user_name 锁定用户使其不能登录

-U user_name 解除锁定

**删除用户**

命令 `userdel` 用以删除用户，单独使用该命令会保存用户的家目录，加参数 `-r `可以在删除用户的同时删除其家目录。

**创建组**

命令 `groupadd` 用以创建组。

**修改组信息**

命令 `groupmod` 用以修改组信息。常用参数有：

-n new_name old_name 修改组名

-g new_Gid old_Gid 修改组ID

**删除组**

命令 `groupdel` 用以删除组。

#### 权限基本操作

权限是Linux限制对资源访问的机制，Linux中，每个文件拥有以下三种权限：

<img src="../../../../../img/blogs/user and group/file_rights.png">

附：对目录来说，必须拥有x权限才能查看，只有r权限而没有x权限是毫无意义的。

**UGO**

Linux权限基于UGO模型进行控制：

* U代表user，G代表group，O代表other
* 每一个文件的权限都基于UGO进行设置
* 权限三个（rwx）一组

命令 ls -l 可以查看所有文件的详细信息，格式如下：

<img src="../../../../../img/blogs/user and group/ls.png">

其中：<img src="../../../../../img/blogs/user and group/ls2.png">

**修改文件所属用户、组**

* 命令` chown` 用以改变文件的所属用户，用法为： `chown user_name file_name`，参数 -R 可以递归修改目录下的所有文件的所属用户。
* 命令 `chgrp` 用以改变文件的所属组，用法为：`chgrp group_name file_name`，同样，参数 -R 可以递归修改该目录下所有文件的所属组。

 
**修改文件权限**

*方法一：*

* 命令 chmod 用以修改文件的权限。用法为：`chmod 模式 file_name`

模式为如下格式：

* u、g、o分别代表用户、组和其他
* a代表all,指ugo
* +、-代表加入或删除对应权限
* r、w、x代表三种权限

e.g.`chomod uo+rw file1`	将文件file1的用户权限和其他用户权限都增加rw

*方法二：*

命令 chmod 也支持以数字的方式修改权限。r、w、x分别对应三个数字：

* r=4(2^2)

* w=2(2^1)

* x=1(2^0)

使用数字设置权限时，只能U、G、O三组权限一起设置，每组权限分别对应数字之和。

e.g `chmod 661 file1`  表示对于文件file1，用户的权限为rw(6=4+2),组权限是rw(6=4+2)，其他用户权限为x。


**默认权限**

每一个终端都有一个 umask 属性，来确定新建文件、文件夹的默认权限。

* 一般，普通用户的默认 umask 是002，root用户的 umask 是022
* 目录的默认权限是：777-umask
* 文件的默认权限是：666-umask

命令` umask `可以查看umask的值，若加上对应的数字，则可以设置umask的值，如：`umask 022`可以将umask值设置为022。

**特殊权限的含义**

除了三个普通权限(r、w、x)外，还有三个特殊权限。

<img src="../../../../../img/blogs/user and group/special.png">

* suid：这个权限我们一般为可执行文件/命令设置，通常，可执行文件/命令都是以执行用户的身份执行的，有时候我们希望其他用户能拥有一些文件的执行权限，然而却不希望对其开放某些文件，此时，就可以设置suid。例如常见的 `passwd `命令 ，，我们都知道，密码存在shadow文件中，其他用户是无法访问shadow文件的，当给passwd命令设置suid时，当其他用户要修改密码时，是以root用户的身份去运行passwd这个命令的，passwd这个命令就有权限向shadow里写入密码，同时其他用户依然无法访问shadow文件，保证了安全性。

* guid：这个权限的作用在表格中已经表述得很清楚了，对于文件的影响和suid类似，但是更多时候我们设置guid这个权限都是为了在目录中创建新文件时，让新文件的所属组和目录的所属组相同，而不是和用户所属组相同。

* sticky：这个权限非常有用，因为通常对于某个目录，需要多个用户都拥有对该目录的读写权限，那么用户之间应该要避免更改或者删除对方的文件，这个权限可以保护用户的文件安全。

**特殊权限的设置**

方法一：我们通过 chmod 来设置特殊权限，具体操作为：

* chmod u+s file_name 给用户设置suid
* chmod g+s file_name 给组设置suid
* chmod o+t file_name 给其他用户设置sticky

方法二：与普通权限一样，特殊权限也可以使用数字方式表示

* suid=4
* guid=2
* sticky=1

所以我们可以通过以下命令设置sticky：chmod 4755 file_name 


