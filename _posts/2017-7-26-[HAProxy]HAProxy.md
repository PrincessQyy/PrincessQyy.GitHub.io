---
layout:     post
title:      "【HAProxy】HAProxy原理和配置"
date:       2017-07-26 17:56:00
author:     "Yuki"
---

## HAProxy简介

HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在时下的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。

HAProxy实现了一种事件驱动、单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户端(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。

HAProxy是免费、极速且可靠的用于为TCP和基于HTTP应用程序提供高可用、负载均衡和代理服务的解决方案，尤其适用于高负载且需要持久连接或7层处理机制的web站点。

#### 性能

HAProxy借助于OS上几种常见的技术来实现性能的最大化。

* 单进程、事件驱动模型显著降低了上下文切换的开销及内存占用。
* O(1)事件检查器(event checker)允许其在高并发连接中对任何连接的任何事件实现即时探测。
* 在任何可用的情况下，单缓冲(single buffering)机制能以不复制任何数据的方式完成读写操作，这会节约大量的CPU时钟周期及内存带宽；
* 借助于Linux 2.6 (>= 2.6.27.19)上的splice()系统调用，HAProxy可以实现零复制转发(Zero-copy forwarding)，在Linux 3.5及以上的OS中还可以实现零复制启动(zero-starting)；
* MRU内存分配器在固定大小的内存池中可实现即时内存分配，这能够显著减少创建一个会话的时长；
* 树型存储：侧重于使用作者多年前开发的弹性二叉树，实现了以O(log(N))的低开销来保持计时器命令、保持运行队列命令及管理轮询及最少连接队列；
* 优化的HTTP首部分析：优化的首部分析功能避免了在HTTP首部分析过程中重读任何内存区域；
* 精心地降低了昂贵的系统调用，大部分工作都在用户空间完成，如时间读取、缓冲聚合及文件描述符的启用和禁用等；

所有的这些细微之处的优化实现了在中等规模负载之上依然有着相当低的CPU负载，甚至于在非常高的负载场景中，5%的用户空间占用率和95%的系统空间占用率也是非常普遍的现象，这意味着HAProxy进程消耗比系统空间消耗低20倍以上。因此，对OS进行性能调优是非常重要的。即使用户空间的占用率提高一倍，其CPU占用率也仅为10%，这也解释了为何7层处理对性能影响有限这一现象。由此，在高端系统上HAProxy的7层性能可轻易超过硬件负载均衡设备。

在生产环境中，在7层处理上使用HAProxy作为昂贵的高端硬件负载均衡设备故障故障时的紧急解决方案也时长可见。硬件负载均衡设备在“报文”级别处理请求，这在支持跨报文请求(request across multiple packets)有着较高的难度，并且它们不缓冲任何数据，因此有着较长的响应时间。对应地，软件负载均衡设备使用TCP缓冲，可建立极长的请求，且有着较大的响应时间。

#### 可以从三个因素来评估负载均衡器的性能：

* 会话率
* 会话并发能力
* 数据率

## 配置HAProxy

### 配置文件格式

HAProxy的配置处理3类来主要参数来源：
	
* ——最优先处理的命令行参数，
* ——“global”配置段，用于设定全局配置参数；
* ——proxy相关配置段，“defaults”、“listen”、“frontend”和“backend”；

### 时间格式

一些包含了值的参数表示时间，如超时时长。这些值一般以毫秒为单位，但也可以使用其它的时间单位后缀。
	
* us: 微秒(microseconds)，即1/1000000秒；
* ms: 毫秒(milliseconds)，即1/1000秒；
* s: 秒(seconds)；
* m: 分钟(minutes)；
* h：小时(hours)；
* d: 天(days)；

#### 例子： 

面的例子配置了一个监听在所有接口的80端口上HTTP proxy服务，它转发所有的请求至后端监听在127.0.0.1:8000上的"server"。

	global
        daemon
        maxconn 25600 //最大连接数

    defaults
        mode http	//代理http
        timeout connect 5000ms		//建立连接的超时时间
        timeout client 50000ms		//客户端空闲连接断开的超时时间
        timeout server 50000ms

    frontend http-in		//前端名称http-in
        bind *:80		//监听前端所有地址的80断口
        default_backend servers		//默认转发至servers
	

    backend servers		//定义servers
        server server1 127.0.0.1:8080 maxconn 32