---
layout:     post
title:      "【LVS】LVS-FNAT模式"
date:       2018-03-09 09:28:00
author:     "Yuki"
---

# LVS-FNAT模式简介

LVS中有四种模式，各有优缺点，无论是DR还是NAT模式，不可避免的都有一个问题：LVS和RS必须在二层可达，否则LVS无法作为RS的网关。

这引发的两个问题是：

1、同一个二层的限制导致运维不方便。

2、LVS的水平扩展受到制约。当RS水平扩容时，总有一天其上的单点LVS会成为瓶颈。

Full-NAT由此而生，解决的是LVS和RS跨二层的问题，而跨二层问题解决后，LVS和RS不再存在二层上的从属关系，可以做到多个LVS对应多个RS，解决水平扩容的问题。

Full-NAT相比NAT的主要改进是，在SNAT/DNAT的基础上，加上另一种转换，转换过程如下：
<img src="../../../../../img/blogs/LVS-FNAT/01.png">


在包从LVS转到RS的过程中，源地址从客户端IP被替换成了LVS的内网IP。

内网IP之间可以通过多个交换机跨VLAN通信。

当RS处理完接受到的包，返回时，会将这个包返回给LVS的内网IP，这一步也不受限于VLAN。

LVS收到包后，在NAT模式修改源地址的基础上，再把RS发来的包中的目标地址从LVS内网IP改为客户端的IP。

Full-NAT主要的思想是把网关和其下机器的通信，改为了普通的网络通信。采用这种方式，LVS和RS的部署在二层环境上将不再有任何限制，大大提高了运维部署的便利性。

# FNAT小实验中用到的命令

### tcpdump

这个是抓包命令，此次实验中我都是用这个命令抓包并进行分析的

**tcpdump常用参数说明**

-i any : 监听所有网卡

-i eth0 : 监听eth0网卡
-D : 显示所有网卡

-n : 禁止解析主机名

-nn : 禁止解析主机名和端口号

-X : 将包的内容按十六进制和ASCII格式显示

-XX : 跟-X选项类型，并额外显示以太协议头

-v，-vv，-vvv : 递增显示包的信息

-c : 最多抓n个包

-s : 定义抓包的大小，-s0抓取全部

-S : 打印绝对的tcp序号

**例子**

* 不指定任何参数，监听第一块网卡上经过的数据包。

`tcpdump`

* 监听特定网卡,主机上可能有不止一块网卡，所以经常需要指定网卡。


`tcpdump -i en0`

* 监听特定主机,如监听本机跟主机182.254.38.55之间往来的通信包。出、入的包都会被监听。

`tcpdump host 182.254.38.55`

* 特定来源、目标地址的通信
* 
`特定来源
tcpdump src host hostname`

`特定目标地址
tcpdump dst host hostname`

* 如果不指定src跟dst，那么来源 或者目标 是hostname的通信都会被监听

`tcpdump host hostname`

* 特定端口

`tcpdump port 3000`

*监听TCP/UDP

`服务器上不同服务分别用了TCP、UDP作为传输层，假如只想监听TCP的数据包:
tcpdump tcp`

* 来源主机+端口+TCP

`监听来自主机123.207.116.169在端口22上的TCP数据包:
tcpdump tcp port 22 and src host 123.207.116.169`

* 监听特定主机之间的通信

`tcpdump ip host 210.27.48.1 and 210.27.48.2`

* 210.27.48.1除了和210.27.48.2之外的主机之间的通信

`tcpdump ip host 210.27.48.1 and ! 210.27.48.2`

* 稍微详细点的例子

`tcpdump tcp -i eth1 -t -s 0 -c 100 and dst port ! 22 and src net 192.168.1.0/24 -w ./target.cap`

(1)tcp: ip icmp arp rarp 和 tcp、udp、icmp这些选项等都要放到第一个参数的位置，用来过滤数据报的类型

(2)-i eth1 : 只抓经过接口eth1的包

(3)-t : 不显示时间戳

(4)-s 0 : 抓取数据包时默认抓取长度为68字节。加上-S 0 后可以抓到完整的数据包


(5)-c 100 : 只抓取100个数据包

(6)dst port ! 22 : 不抓取目标端口是22的数据包

(7)src net 192.168.1.0/24 : 数据包的源网络地址为192.168.1.0/24

(8)-w ./target.cap : 保存成cap文件，方便用ethereal(即wireshark)分析


* 限制抓包的数量
如下，抓到1000个包后，自动退出

`tcpdump -c 1000`

* 保存到本地

备注：tcpdump默认会将输出写到缓冲区，只有缓冲区内容达到一定的大小，或者tcpdump退出时，才会将输出写到本地磁盘

`tcpdump -n -vvv -c 1000 -w /tmp/tcpdump_save.cap`

也可以加上-U强制立即写到本地磁盘（一般不建议，性能相对较差）

### nmap

一般在本机上查看端口时,最好使用netstat,因为它安全又可靠,如果找不到端口,或不知道端口的作用是什么,尤其在/etc/services中没有提到的端口对应的服务,就可以使用nmap命令.这个命令是系统管理员用来管理系统安全性的工具,可以通过它了解我们主机端口到底有什么作用.

此次试验中，主要是用该命令从 client 向 server 端发送 tcp 层的请求，用以分析FNAT模式下ip的转换。


**语法:**

`nmap <扫描类型> <扫描参数> <IP地址与范围>`
 
* 扫描类型:主要有以下几种.

   -sT:扫描TCP数据包以建立的连接connect()
   
   -sS:扫描TCP数据包带有SYN数据的标记
   
   -sP:以ping方式进行扫描
   
   -sU:以UDP数据包格式进行扫描
   
   -sO:以IP协议进行主机扫描
 
* 扫描参数:主要有以下几种.

   -PT:使用TCP的ping方式进行扫描,可以获取当前已经启动几台计算机 
   
   -PI:使用实际的ping(带有ICMP数据包)进行扫描
   
   -p:这个是端口范围,如:1024~,80~1023,30000~60000
 
* IP地址与范围:有以下几种类型:

   192.168.0.100:直接写入IP,仅检查一台主机
   
   192.168.0.0/24:为C Class的网段
   
   192.168.\*.*:以B Class的网段,扫描范围更广
   
   192.168.0.0~50,60~100,103,200:变形的主机范围
 
* 举例:

  `扫描本机：nmap localhost `

  `扫描本机的一部分端口：nmap -p 1024-65535 localhost `

  `以ping的方式扫描数台主机：nmap -PT 192.168.1.171-177 `


### curl 

curl命令是一个功能强大的网络工具，它能够通过http、ftp等方式下载文件，也能够上传文件。其实curl远不止前面所说的那些功能，可以通过man curl阅读手册页获取更多的信息。类似的工具还有wget。

curl命令使用了libcurl库来实现，libcurl库常用在C程序中用来处理HTTP请求，curlpp是libcurl的一个C++封装，这几个东西可以用在抓取网页、网络监控等方面的开发，而curl命令可以帮助来解决开发过程中遇到的问题。

这次实验中这个命令主要是用以从 client 端向 server 端发送七层的请求。

**常用参数**

-v/--verbose 小写的v参数，用于打印更多信息，包括发送的请求信息，这在调试脚本是特别有用。

-m/--max-time \<seconds> 指定处理的最大时长

-H/--header \<header> 指定请求头参数

-s/--slient 减少输出的信息，比如进度

--connect-timeout \<seconds> 指定尝试连接的最大时长

-x/--proxy \<proxyhost[:port]> 指定代理服务器地址和端口，端口默认为1080

-T/--upload-file \<file> 指定上传文件路径

-o/--output \<file> 指定输出文件名称

-d/--data/--data-ascii \<data> 指定POST的内容

--retry \<num> 指定重试次数

-e/--referer \<URL> 指定引用地址

-I/--head 仅返回头部信息，使用HEAD请求

### ping 

ping命令能够用于判断一个主机是否可达或者是否存活。它的工作原理就像潜水艇的探测原理一样。该命令通过向目标计算机发送一个数据包，请求目标计算机回送该数据包以表明自己还存活着。同时该命令还能够知道数据包的来回需要多长时间，知道数据包的丢失情况。如果想知道一个服务器或计算机是否正在进行，该命令是非常有用的。另外，该命令也能够诊断网络延时或者数据包丢失情况。

**语法**

`ping(选项)(参数)`

* 选项

-d：使用Socket的SO_DEBUG功能

-c<完成次数>：设置完成要求回应的次数

-f：极限检测

-i<间隔秒数>：指定收发信息的间隔时间

-I<网络界面>：使用指定的网络界面送出数据包

-l<前置载入>：设置在送出要求信息之前，先行发出的数据包

-n：只输出数值

-p<范本样式>：设置填满数据包的范本样式

-q：不显示指令执行过程，开头和结尾的相关信息除外

-r：忽略普通的Routing Table，直接将数据包送到远端主机上

-R：记录路由过程

-s<数据包大小>：设置数据包的大小

-t<存活数值>：设置存活数值TTL的大小

-v：详细显示指令的执行过程

* 参数

目的主机ip：指定发送ICMP报文的目的主机。
