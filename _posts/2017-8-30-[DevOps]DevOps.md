---
layout:     post
title:      "【DevOps】运维场景"
date:       2017-08-30 17:04:00
author:     "Yuki"
---

# nginx占用大量磁盘空间问题分析

#### 场景：Nginx占用大量磁盘空间，在删除了近100G的日志文件后，用df命令查看，发现空间并没有得到释放，为什么？

#### 解答：一个文件被进程打开后，在关闭前如果文件被删除，此时这个文件已经在它父目录的目录项中被删除掉（在父目录ls已经看不到这个文件），但该进程依然能够正常的读写文件，直到文件被该进程关闭后，这个文件的空间才会被回收。

# socket端口数量限制问题

#### 场景：linux socket使用16bit无符号整型表示端口号，最大到65535。关于端口号，有一个经典的误解就是，因为端口号有限，所以一个客户端最多建立65536个socket连接，但实际上并不是这么回事，端口是可以复用的。

#### 一个socket连接是一个[srcip, srcport, destip, destport]组成的四元组，如果再算上协议（tcp、udp、rawsocket等）就是五元组了，这个四元组中，只要有一个元素不同，就能区分两个连接；我们平时所遇到端口不够用的问题，大多出现在压测环境中，用客户端不断向某一个服务器建立连接发请求，当连接超过一定数量后，connect会出错提示Cannot assign requested address。对于这样的场景，四元组的destip，destport是确定的，对于单网卡机器srcip也是确定的（不考虑虚拟网卡情况），可变的就只有srcport，而端口的取值只能在0-65535，再加上系统的一些保留端口是不可用的，所以客户端到该特定服务间的连接数就受端口数目的限制，当连接到其他服务器时，本地的端口是可以复用的。实际上，在 不指定端口的情况下连接服务器，可用的端口号在/proc/sys/net/ipv4/ip_local_port_range中配置，默认为32768-61000。

